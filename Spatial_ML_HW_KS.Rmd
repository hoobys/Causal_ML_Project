---
title: "Analysis of Accident Severity in Proximity to Hotspots"
output: html_document
---

## Introduction to the Analysis of Accident Severity in Proximity to Hotspots

Road safety is a paramount concern for both individuals and authorities, with the impact of traffic accidents ranging from minor to fatal. Understanding the factors that contribute to the severity of these incidents can inform preventive measures and policies. This analysis aims to investigate the influence of the distance from accident sites to traffic hotspots—locations where accidents occur more frequently—on the severity of these accidents. The working hypothesis suggests that accidents occurring closer to hotspots are more likely to result in minor (slight) injuries rather than being fatal.

To conduct this investigation, data from the year 2017 were sourced from a comprehensive UK road safety dataset available at [Kaggle](https://www.kaggle.com/datasets/tsiaras/uk-road-safety-accidents-and-vehicles?select=Accident_Information.csv). The dataset encompasses detailed reports of road accidents, providing a fertile ground for spatial and quantitative analysis.

### Methodology

The methodology of the analysis involves several stages:

- **Spatial Clustering**: Using the DBSCAN clustering method, accident locations defined by longitude and latitude were grouped to identify areas of high accident concentration.

- **Hotspot Identification**: The centers of the identified clusters were calculated, establishing the hotspots. Subsequently, the distances of specific accident sites to these hotspots were determined.

- **Data Modeling**: With the distances and other relevant variables at hand, the XGBoost algorithm was employed to model the data and examine the relationship between proximity to hotspots and accident severity.

The outcome of this analysis aims to shed light on the spatial dynamics of road accidents and their outcomes, potentially offering insights into road safety enhancement strategies.

```{r}
library(tidyverse)
library(readr)
library(lubridate)
library(ggplot2)
library(sf)
library(here)
library(dbscan)
library(leaflet)
library(geosphere)
library(randomForest)
library(pROC)
library(caret)
library(viridis)
library(ggridges)
library(xgboost)

setwd(here())
```
## Read data

```{r}
accident_data <- read_csv("accident_data.csv")

summary(accident_data)
head(accident_data)
```

```{r}
unique(accident_data$Year)
```


```{r}
accident_data <- accident_data %>%
  select(
    Longitude, Latitude,
    Accident_Severity,
    Date, Time,
    Weather_Conditions, Light_Conditions,
    Road_Surface_Conditions,
    "1st_Road_Class", "2nd_Road_Class",
    Speed_limit,
    "Pedestrian_Crossing-Human_Control",
    "Pedestrian_Crossing-Physical_Facilities",
    Urban_or_Rural_Area,
    Number_of_Casualties, Number_of_Vehicles
  )
```

## Data adjustments

```{r}
accident_data <- accident_data %>%
  filter(!is.na(Longitude), !is.na(Latitude))
```

```{r}
accident_data$Accident_Severity <- accident_data$Accident_Severity %>%
  recode("Slight" = 0, "Severe" = 1, "Fatal" = 1)

accident_data$Date <- as.Date(accident_data$Date, format = "%Y-%m-%d")
accident_data$Year <- format(accident_data$Date, "%Y")

accident_data$Day_of_Week <- weekdays(accident_data$Date)
accident_data$Month <- format(accident_data$Date, "%m")
accident_data$Hour <- hour(hms(accident_data$Time))

accident_data$TimeOfDay <- cut(accident_data$Hour,
  breaks = c(-Inf, 6, 12, 18, Inf),
  labels = c("Night", "Morning", "Afternoon", "Evening")
)
```
## DBSCAN clustering

```{r}
# Convert Longitude and Latitude to a matrix
coordinates <- as.matrix(accident_data[, c("Longitude", "Latitude")])
```

```{r}
# Perform DBSCAN clustering
dbscan_result <- dbscan(coordinates, eps = 0.1, minPts = 500)

# Extract cluster labels
cluster_labels <- dbscan_result$cluster

# Add cluster labels to the accident_data dataframe
accident_data$Cluster <- cluster_labels

# Filter the accident_data dataframe to include only observations in a cluster
clustered_accident_data <- accident_data[accident_data$Cluster > 0, ]
```

## Calculate distance to hotspots

```{r}
# Calculate the centroids of the clusters
centroids <- tapply(
  seq_len(nrow(clustered_accident_data)),
  clustered_accident_data$Cluster,
  function(rows) colMeans(clustered_accident_data[rows, 1:2])
)

# Calculate the distance from each point to its closest centroid
accident_data$DistanceToHotspot <- apply(coordinates, 1, function(coord) {
  min(sapply(centroids, function(centroid) dist(rbind(coord, centroid))))
})
```

```{r}
summary(accident_data$DistanceToHotspot)
```
## Plot clustering outcome

```{r}
# Create a color palette for clusters
cluster_palette <- colorFactor(
  palette = "Set1",
  domain = clustered_accident_data$Cluster
)

# Create a leaflet map with a random sample of points
map <- leaflet() %>%
  addTiles() %>%
  addCircleMarkers(
    data = sample_n(clustered_accident_data, size = 10000),
    lng = ~Longitude,
    lat = ~Latitude,
    color = ~ cluster_palette(Cluster),
    radius = 3,
    popup = ~ paste("Grid Cell:", Cluster)
  )
map
```

## Clustering summary

The clustering analysis depicted on the map has successfully identified 29 distinct clusters, primarily situated near densely populated areas such as major cities and urban agglomerations. This pattern is not unexpected as higher traffic volumes in such areas typically lead to a greater number of incidents. The visualization clearly indicates these hotspots, with varying cluster sizes likely reflecting the intensity of traffic accident occurrences. Recognizing these clusters is instrumental for urban planners and public safety officials, as it can guide traffic management strategies, resource deployment for emergency services, and the implementation of safety measures to mitigate accident risks in these high-density zones.

## Exploratory Data Analysis

```{r}
accident_data <- accident_data[, !(names(accident_data) %in% c(
  "Longitude", "Latitude", "Cluster", "Hour", "Number_of_Casualties",
  "Date", "Time", "Year", "1st_Road_Class", "2nd_Road_Class",
  "Pedestrian_Crossing-Human_Control", "Pedestrian_Crossing-Physical_Facilities"
))]

accident_data <- accident_data[!is.na(accident_data$Accident_Severity), ]

# Convert all columns to factors
accident_data <- accident_data %>%
  mutate_if(is.character, as.factor)

summary(accident_data)
```
EDA
```{r}
ggplot(accident_data, aes(x=factor(Accident_Severity), fill=factor(Accident_Severity))) +
  geom_bar(stat="count") +
  scale_fill_manual(values=c("0"="blue", "1"="red"),
                    labels=c("0"="Slight", "1"="Severe or Fatal"),
                    name="Accident Severity") +  # This line sets manual colors and labels
  labs(x="Accident Severity",
       y="Count",
       title="Distribution of Accident Severity") +
  theme_minimal()
```

```{r}
ggplot(accident_data, aes(x=Speed_limit, fill=..count..)) +
  geom_histogram(binwidth=10, color="black", show.legend=FALSE) +  
  scale_fill_viridis(name="Frequency", option="D") +  
  labs(x="Speed Limit",
       y="Frequency",
       title="Distribution of Speed Limits") +
  theme_minimal()
```
```{r}
ggplot(accident_data, aes(x = Weather_Conditions, fill = Weather_Conditions)) +
  geom_bar() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Accidents in Different Weather Conditions", x = "Weather Conditions", y = "Count")
```

```{r}
day_mapping <- setNames(c('Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'),
                        c('poniedziałek', 'wtorek', 'środa', 'czwartek', 'piątek', 'sobota', 'niedziela'))

accident_data$Day_of_Week <- day_mapping[accident_data$Day_of_Week]
```

```{r}
ggplot(accident_data, aes(x=Day_of_Week, fill=factor(Accident_Severity))) +
  geom_bar(position="dodge") +
  scale_fill_manual(values=c("0"="lightblue", "1"="red"),
                    labels=c("0"="Slight", "1"="Severe or Fatal"),
                    name="Accident Severity") +
  labs(x="Day of the Week",
       y="Count",
       title="Day of the Week vs Accident Severity") +
  theme_light() +
  theme(
    panel.background = element_rect(fill = "white", colour = "white"),
    plot.background = element_rect(fill = "white", colour = NA),
    legend.background = element_rect(fill = "white", colour = NA),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```
```{r}
ggplot(accident_data, aes(x=TimeOfDay, fill=factor(Accident_Severity))) +
  geom_bar(position="dodge") +
  scale_fill_manual(values=c("0"="lightblue", "1"="red"),
                    labels=c("0"="Slight", "1"="Severe or Fatal"),
                    name="Accident Severity") +
  labs(x="Time of Day",
       y="Count",
       title="Time of Day vs Accident Severity") +
  theme_light() +
  theme(
    panel.background = element_rect(fill = "white", colour = "white"),
    plot.background = element_rect(fill = "white", colour = NA),
    legend.background = element_rect(fill = "white", colour = NA),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

```{r}
ggplot(accident_data, aes(x=DistanceToHotspot)) +
  geom_density(fill="skyblue", alpha=0.5) +
  xlim(0, 2) +
  labs(x="Distance to Hotspot",
       y="Density",
       title="Empirical Density Function of Distance to Hotspot") +
  theme_minimal()
```
```{r}
ggplot(accident_data, aes(x=factor(Accident_Severity), y=DistanceToHotspot)) +
  geom_violin(trim=FALSE, fill="skyblue", color="black") +
  scale_x_discrete(name="Accident Severity", 
                   labels=c("0"="Slight", "1"="Severe or Fatal")) + 
  theme_minimal()
```

```{r}
ggplot(accident_data, aes(x=DistanceToHotspot, fill=factor(Accident_Severity))) +
  geom_density(alpha=0.5) +
  facet_grid(Accident_Severity ~ .) +
  scale_x_continuous(limits=c(0, 2)) +  
  scale_fill_manual(values=c("0"="lightblue", "1"="red"),
                    labels=c("0"="Slight", "1"="Severe or Fatal"),
                    name="Accident Severity") +  
  theme_minimal()
```
## Exploratory Data Analysis Summary

The exploratory data analysis stage provided several key insights from the visualizations created:

### Distance to Hotspot
- The spread in the slight category closer to hotspots indicates that minor accidents are more concentrated around these areas. Conversely, severe or fatal accidents appear to happen at various distances from hotspots, suggesting a different set of factors may influence the more serious accidents.

### Weather Conditions
- The majority of accidents occur in clear weather conditions ("Fine no high winds"), which is likely a reflection of the predominance of such weather in the dataset. Adverse weather conditions, like rain or snow, are associated with fewer accidents. This might be due to more cautious driving or fewer people traveling under these conditions.

### Day of the Week
- Fridays experience the highest number of accidents, while Sundays have the fewest. This pattern may relate to the rhythms of workweek travel and weekend behaviors. Notably, the severity of accidents does not vary markedly with the day of the week.

### Time of Day
- Afternoon hours see a spike in accident counts, possibly linked to increased traffic volume. Nighttime has the fewest accidents, which could be attributed to lower traffic density. The severity of accidents does not seem to be influenced proportionally by the time of day.

### Speed Limits
- The distribution of accidents peaks at a speed limit of 30 units, hinting that most accidents occur in areas with this speed limit, potentially in urban settings where such limits are common.


